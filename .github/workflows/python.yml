name: Python Tests

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Build the Stack
      run: docker compose up -d --build

    - name: Wait for services to be healthy
      run: |
        echo "Waiting for web service..."
        for i in $(seq 1 30); do
          if docker compose exec -T web python -c "import django" 2>/dev/null; then
            echo "Web service is ready"
            break
          fi
          echo "Attempt $i/30 â€” waiting 5s..."
          sleep 5
        done

    - name: List containers
      run: docker compose ps

    - name: Run Django Tests
      run: docker compose exec -e TESTING=True -T web pytest

    - name: Tear down the Stack
      if: always()
      run: docker compose down
